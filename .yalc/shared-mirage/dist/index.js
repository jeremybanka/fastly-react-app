!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("faker"),require("miragejs")):"function"==typeof define&&define.amd?define(["exports","faker","miragejs"],t):t((e="undefined"!=typeof globalThis?globalThis:e||self)["shared-mirage"]={},e.faker,e.miragejs)}(this,(function(e,t,r){"use strict";function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var a=s(t);const n={datacenters:["AMS","LAX"],origins:[{name:"One_I_P__Origin"},{name:"s_multipleIpOrigin"}]},i=(e=1e3,{environment:t="development"})=>"test"===t?0:e,o=e=>new Promise((t=>setTimeout(t,e))),u=(e=.5)=>a.default.datatype.number({min:0,max:1,precision:.1})<=e,m=e=>Array.from({length:e},((e,t)=>t)),d={responseTime:i,delay:o,randomTrue:u,range:m},c=e=>e&&"origin_insights"===e.kind,l=(e,t)=>{for(const[r,s]of Object.entries(e))"miss_histogram"==r?t[r]=l(s,t[r]||{}):isNaN(s)||(t[r]=s+(t[r]||0));return t},p=e=>Object.entries((e=>({includeCompute:()=>!u(e.fakeWhistlerChanceOfEmpty),includeOriginFetches:()=>u(.5),includeImage:()=>u(.3)}))(e)).map((([e,t])=>t()?e:null)).filter((e=>e)),_=({config:e,server:t,iterations:r,timestamp:s,isOriginInspector:a},i)=>{const o=Math.floor((s||Date.now())/1e3),u=Math.floor(Date.now()/1e3);let d=r||u-o;return i?d=0:d<=0?d=1:d>120&&(d=120),{Data:m(d).map((r=>a?((e,t)=>{const r={datacenter:{},aggregated:{},recorded:t};return n.datacenters.forEach((t=>{r.datacenter[t]={},n.origins.forEach((s=>{const a=e.create("whistler-origin");r.datacenter[t][s.name]=a,r.aggregated[s.name]=l(a,r.aggregated[s.name]||{})}))})),r})(t,u-r):((e,t,r)=>{const s={datacenter:{},aggregated:{},recorded:r};return n.datacenters.forEach((r=>{const a=e.create("whistler-overview",...p(t));s.datacenter[r]=a,s.aggregated=l(a,s.aggregated)})),s})(t,e,u-r))).reverse(),AggregateDelay:9,Timestamp:u-1}},y=async(e,t=!0)=>!t&&u(e.config.fakeWhistlerChanceOfEmpty)?(await o(5e3),_(e,!0)):_(e);function f(e,t){const r=t.requestHeaders["fastly-key"],s=e.schema.tokens.findBy({access_token:r});if(!s)return console.error(`No token found for fastly-key ${r}`),null;const a=s.customer;a||console.error(`No customer found for fastly-key ${r}`);const n=s.user;return n||console.error(`No user found for fastly-key ${r}`),{customer:a,user:n,token:s}}const h={Auth:function(e,{origin:t=""}){e.get(`${t}/verify`,(function(t,r){const{customer:s,user:a,token:n}=f(e,r),i=t.features.all().models;let o=null;if(r.queryParams.active_services_only){const e=t.services.where({customer_id:s.id});if(e.models){const t=e.models.map((({id:e,name:t})=>[e,t]));o=Object.fromEntries(t)}else o={}}n.update({updated_at:"new value"}),localStorage.removeItem("keepTokens");const u={customer:s,user:a,features:i.map((e=>e.name)),token:n.attrs,services:o},m=a.userGroups&&a.userGroups.models;if(m&&m.length){const e=m.reduce(((e,t)=>[...e,...t.roles.models]),[]).map((e=>e.permissions.models))[0],t=function({id:e,name:t,operation:r,resource:s}){return{id:e,name:t,operation:r,resource:s}},r=e.filter((e=>["account","internal"].includes(e.scope))).map((e=>t(e))),s=e.filter((e=>"service"===e.scope)).map((e=>t(e))),a={account_permissions:r.map((({id:e})=>e)),service_permissions:[{service_id:"all_services",permissions:s.map((({id:e})=>e))}]};u.authorized_permissions=a}try{return this.serialize(u,"session")}catch(e){return u}})),e.get(`${t}/customer-features`),e.get(`${t}/customer-features/:id`),e.get(`${t}/customers`,(function(e,t){const r=(t.queryParams["filter[name][match]"]||"").toLowerCase();return e.customers.where((e=>e.name&&e.name.toLowerCase().includes(r)))})),e.get(`${t}/customers/:id`,"customer"),e.get(`${t}/services`,(function(e,t){const r=(t.queryParams["filter[name][match]"]||"").toLowerCase();return"oopsie.woopsie.com"===t.queryParams["filter[domains.name]"]?new Response(400,{},{errors:[{detail:"oh no! something went horribly wrong"}]}):e.services.where((e=>e.name.toLowerCase().includes(r)))})),e.get(`${t}/current_user/capabilities`,"customer-capability"),e.get(`${t}/features`),e.get(`${t}/features/:id`)},Whistler:function({server:e,config:t}){e.get(`${t.whistler.origin}/v1/channel/:serviceId/ts/h/limit/:limit`,(async(r,{params:s,queryParams:a})=>await y({server:e,config:t,iterations:s.limit||120,isOriginInspector:c(a)},!0)),{timing:0}),e.get(`${t.whistler.origin}/v1/channel/:serviceId/ts/:ts`,(async(r,{params:s,queryParams:a})=>await y({server:e,config:t,timestamp:parseInt(1e3*s.ts),isOriginInspector:c(a)})),{timing:i(1e3,t)})}};var b=r.Factory.extend({resp_body_bytes:()=>a.default.datatype.number({min:1,max:1e5}),resp_header_bytes:()=>a.default.datatype.number({min:1,max:1e3}),responses:()=>a.default.datatype.number({min:0,max:22e4}),status_1xx:()=>u(.5)?a.default.datatype.number({min:1,max:1e5}):0,status_2xx:()=>a.default.datatype.number({min:0,max:1e5}),status_3xx:()=>a.default.datatype.number({min:0,max:3e3}),status_4xx:()=>a.default.datatype.number({min:0,max:11e3}),status_5xx:()=>u(.5)?a.default.datatype.number({min:0,max:10}):0});const g=()=>u(.03),x=r.Factory.extend({requests(){return this.errors+this.hits+this.misses+this.synths+this.passes},tls(){return this.requests},log:()=>a.default.datatype.number({min:1,max:1e3}),logging(){return this.log},errors:()=>a.default.datatype.number({min:100,max:1e5})+(g()?a.default.datatype.number({min:100,max:1e5}):0),hits:()=>a.default.datatype.number({min:1e4,max:9e5})+(g()?a.default.datatype.number({min:1e4,max:9e5}):0),synths:()=>a.default.datatype.number({min:0,max:35}),passes:()=>a.default.datatype.number({min:80,max:325}),miss_histogram(){const e={1:2e4};return m(15).forEach(((t,r)=>{e[r*a.default.datatype.number({min:1,max:2e3})]=10*a.default.datatype.number({min:1,max:1e3})})),e},misses(){return Object.keys(this.miss_histogram).reduce(((e,t)=>e+this.miss_histogram[t]),0)},miss(){return this.misses},header_size:()=>a.default.datatype.number({min:1e6,max:8e6}),resp_header_bytes(){return this.header_size},billed_header_bytes(){return this.header_size},body_size:()=>a.default.datatype.number({min:1e7,max:5e7}),resp_body_bytes(){return this.body_size},billed_body_bytes(){return this.body_size},status_2xx:()=>a.default.datatype.number({min:0,max:1e5}),status_200(){return this.status_2xx},status_3xx:()=>a.default.datatype.number({min:0,max:3e3}),status_304(){return this.status_3xx},hits_time:()=>a.default.datatype.number({min:1,max:100,precision:1e-4}),miss_time:()=>a.default.datatype.number({min:25e3,max:125e3,precision:1e-4}),pass_time:()=>a.default.datatype.number({min:1,max:100,precision:1e-4}),hit_resp_body_bytes(){return this.body_size},log_bytes(){return this.log*a.default.datatype.number({min:1e3,max:8e3})},edge_requests(){return this.hits+this.misses},edge_resp_header_bytes(){return this.header_size},edge_resp_body_bytes(){return this.body_size},edge_hit_requests(){return this.hits},edge_miss_requests(){return this.misses},bereq_header_bytes(){return Math.floor(this.body_size/5)},recorded:()=>Math.floor(Date.now()/1e3),includeCompute:r.trait({compute_requests:()=>a.default.datatype.number({min:1,max:5}),compute_execution_time_ms(){return a.default.datatype.number({min:1e4,max:5e4})*this.compute_requests},compute_ram_used(){return 15e5*this.compute_requests},compute_request_time_ms(){return this.compute_execution_time_ms*a.default.datatype.number({min:1,max:2,precision:1e-4})},compute_bereq_body_bytes(){return a.default.datatype.number({min:1e4,max:1e6})*this.compute_requests},compute_bereq_header_bytes(){return a.default.datatype.number({min:1e4,max:1e6})*this.compute_requests},compute_beresp_body_bytes(){return a.default.datatype.number({min:1e4,max:1e6})*this.compute_requests},compute_beresp_header_bytes(){return a.default.datatype.number({min:1e4,max:1e6})*this.compute_requests},compute_req_body_bytes(){return a.default.datatype.number({min:1e4,max:1e6})*this.compute_requests},compute_req_header_bytes(){return a.default.datatype.number({min:1e4,max:1e6})*this.compute_requests},compute_resp_body_bytes(){return a.default.datatype.number({min:1e4,max:1e6})*this.compute_requests},compute_resp_header_bytes(){return a.default.datatype.number({min:1e4,max:1e6})*this.compute_requests},compute_resp_status_1xx(){return a.default.datatype.number({min:0,max:1e6})*this.compute_requests},compute_resp_status_2xx(){return a.default.datatype.number({min:0,max:1e6})*this.compute_requests},compute_resp_status_3xx(){return a.default.datatype.number({min:0,max:1e6})*this.compute_requests},compute_resp_status_4xx(){return a.default.datatype.number({min:0,max:1e6})*this.compute_requests},compute_resp_status_5xx(){return a.default.datatype.number({min:0,max:1e6})*this.compute_requests}}),includeOriginFetches:r.trait({origin_cache_fetches(){return this.misses},origin_fetches(){return this.misses},origin_fetch_body_bytes:()=>Math.floor(a.default.datatype.number({min:1e7,max:5e7})/5),origin_fetch_header_bytes(){return this.bereq_header_bytes},origin_fetch_resp_body_bytes:()=>Math.floor(a.default.datatype.number({min:1e7,max:5e7})/3),origin_fetch_resp_header_bytes:()=>Math.floor(a.default.datatype.number({min:1e6,max:8e6})/3)}),includeImage:r.trait({imgopto:()=>a.default.datatype.number({min:5e3,max:1e4}),imgvideo:()=>a.default.datatype.number({min:300,max:800}),imgvideo_frames(){return 111*this.imgvideo}})});var v=r.Factory.extend({customer:null,id(){const{customer:e}=this;if(null==e||null==e.id)throw new Error("cannot create a customer-capability without a customer");return`someuserid-${e.id}-capabilities`},invitation:()=>[],purge:()=>[],service:()=>[],stats:()=>[],tls:()=>[]}),k=r.Factory.extend({}),q=r.Factory.extend({name:()=>a.default.company.companyName()});const w=["private","public"];const T={WhistlerOrigin:b,WhistlerOverview:x,CustomerCapability:v,CustomerFeature:k,Customer:q,Feature:r.Factory.extend({availability:()=>a.default.random.arrayElement(w),displayName:()=>a.default.commerce.productName(),enabled:!0,name(){return this.displayName.replaceAll(" ","_").toLowerCase()}}),Token:r.Factory.extend({name:"manage.secretcdn-stg.net browser session",access_token:e=>`access_token___${e}`}),User:r.Factory.extend({emailHash:"76ceecc04ee4a5b39c0071b6dfcdda8c",login:e=>0===e?"testadmin@fastly.com":a.default.internet.email(),name:e=>0===e?"Test Admin":`${a.default.name.firstName()} ${a.default.name.lastName()}`,role:"admin"})},I={WhistlerSetup:n},O={getDataFromRequest:f,Helpers:d};var S=r.Model.extend({save(){return null==this.attrs.createdAt&&(this.attrs.createdAt=new Date),this.attrs.updatedAt=new Date,r.Model.prototype.save.apply(this,arguments),this}}),z=S.extend({customer:r.belongsTo(),invitation:null,purge:null,service:null,stats:null,tls:null}),M=r.Model.extend({customer:r.belongsTo(),feature:r.belongsTo()}),N=S.extend({customerCapabilities:r.hasMany(),features:r.hasMany(),name:null,services:r.hasMany(),enabledFeatureNames(){return this.features.models.map((e=>e.name))}}),$=r.Model.extend({customerFeatures:r.hasMany()}),F=S.extend({customer:r.belongsTo("customer")});const A="fastly-auth__session__active-token",C="fastly-auth__session__token-store";const P=new class{get token(){try{return JSON.parse(sessionStorage.getItem(A)||"")}catch(e){return null}}set token(e){try{if(null===e)return void this.clearTokens();sessionStorage.setItem(A,JSON.stringify(e)),this.addTokenToStore(e)}catch(e){return void console.error(e)}}get tokenStore(){try{const e=localStorage.getItem(C);return e?JSON.parse(e):{}}catch(e){return{}}}addTokenToStore(e){this.tokenStore[e.customer_id]=e,localStorage.setItem(C,JSON.stringify(this.tokenStore))}clearTokens(){localStorage.removeItem(C),sessionStorage.removeItem(A)}};var j=S.extend({customer:r.belongsTo(),user:r.belongsTo(),save(...e){const t=S.prototype.save.apply(this,e),{_schema:r}=this;return 1!==r.tokens.all().length||localStorage.getItem("keepTokens")||(P.clearTokens(),P.token=t.attrs),t},destroy(){return P.clearTokens(),S.prototype.destroy.apply(this,arguments)}});const D={customerCapability:z,customerFeature:M,customer:N,feature:$,service:F,token:j,user:S.extend({role:null,login:null,customer:r.belongsTo(),tokens:r.hasMany()})};var E=r.JSONAPISerializer.extend({}),L=r.JSONAPISerializer.extend({alwaysIncludeLinkageData:!0});const J={fastly:{models:D,factories:T,fixtures:I,serializers:{application:E,customerFeature:L.extend({serialize(e,t){return Array.isArray(e)&&(e=function(e,t){const r=t.queryParams["filter[customer_id]"],s=t.queryParams["filter[feature_id]"];r&&(e=e.filter((e=>e.customerId===r)));s&&(e=e.filter((e=>e.featureId===s)));return e}(e,t)),L.prototype.serialize.call(this,e,t)}}),feature:L.extend({serialize(e,t){return Array.isArray(e)&&(e=function(e,t){const r=t.queryParams.sort;return e=e.sort(((e,t)=>e[r]>t[r]))}(e,t)),L.prototype.serialize.call(this,e,t)}})}},routes:h,utils:O};e.default=J,Object.defineProperty(e,"__esModule",{value:!0})}));
