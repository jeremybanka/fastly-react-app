import { bool, not } from '@ember/object/computed'
import checkHeaders from '@fastly/auth/utils/check-headers'
import Component from '@ember/component'
import hbs from 'htmlbars-inline-precompile'
import { inject as service } from '@ember/service'
import { set } from '@ember/object'

export default Component.extend({
  session: service(),
  router: service(),

  // Internal properties
  // ---------------------------------------------------------------------------

  tagName: '',
  otp: null,
  errorMessage: null,
  isRequestRunning: false,
  isPasswordPresent: bool('otp'),
  isPasswordMissing: not('isPasswordPresent'),

  // CRUFT: There is a collision between style-guide's implementation of form-group
  // and Tango's. see https://github.com/fastly/Tango/blob/d36803b45ee066ad194b04efe5f4bf3b3a6119fc/app/pods/components/fui-field-label/component.js#L30
  // Remove after that is resolved in Tango.    --- Jeneve Parrish 5/20/2020
  registerLabelView: () => {},

  // Methods
  // ---------------------------------------------------------------------------

  submitOTP() {
    event.preventDefault()
    this.setProperties({
      isRequestRunning: true,
      errorMessage: null,
    })

    if (this.isPasswordMissing) {
      this.setProperties({
        errorMessage: {
          type: 'error',
          body: 'Enter a valid code.',
        },
        isRequestRunning: false,
      })
      return
    }

    const { customerId, options = {} } =
      this.session.switchCustomerParams === undefined ? {} : this.session.switchCustomerParams

    return this.session
      .switchAccount(customerId, { ...options, otp: this.otp })
      .catch((err) => {
        // only need handle otp invalid, display the error.
        const { payload, responseJSON } = err
        if (checkHeaders(err) === 'otp:required') {
          set(this, 'errorMessage', {
            type: 'error',
            body: (payload || responseJSON).error_description,
          })
        } else {
          throw err
        }
      })
      .finally(() => {
        if (!this.isDestroyed && !this.isDestroying) {
          set(this, 'isRequestRunning', false)
        }
      })
  },

  // Template
  // ---------------------------------------------------------------------------
  layout: hbs`
    <h1 class='fui-auth-screen__header'>
      Two-factor authentication
    </h1>

    <form class='fui-auth-screen__form' role='form' {{action submitOTP on='submit'}}>
      <p>
        Enter the code generated by your two-factor authentication app to sign in.
        <ExternalLinkTo
          @text='Contact support'
          @href='https://www.fastly.com/support'
        /> if you don't have access to the mobile device that generates the
        authentication code or if you don't have a
        <ExternalLinkTo
          @text='valid recovery code'
          @href='https://docs.fastly.com/guides/account-management-and-security/enabling-and-disabling-two-factor-authentication#what-to-do-if-you-lose-your-mobile-device'
        />.
      </p>
      {{#if errorMessage}}
        <FuiAuthError
          @class="margin-bottom--l"
          @errorText="Two-factor authentication failed. Try again or "
          id='otp-validation'
        />
      {{/if}}
      <FuiAuthInput
        @label='Authentication code'
        @value={{otp}}
        autocomplete='off'
        autofocus={{true}}
        name='2fa-token'
        aria-describedby='otp-validation'
        placeholder='Enter 2FA code'
        aria-invalid={{isPasswordMissing}}
      />
      <button
        disabled={{isRequestRunning}}
        class='fui-auth-form__button'
        type='submit'
      >
        Sign in
      </button>
    </form>
  `,
})
